<!-- Dropdowns -->
<select id="institutionSelect">
  <option value="">-- Select Institution --</option>
</select>

<select id="eventSelect" disabled>
  <option value="">-- Select Event --</option>
</select>

<select id="descSelect" disabled>
  <option value="">-- Select --</option>
</select>

<!-- Invoice Section -->
<div id="invoice" style="display:none;">
  <p>Invoice No: <span id="invNo"></span></p>
  <p>Date: <span id="invDate"></span></p>
  <p>SI No: <span id="siCell"></span></p>
  <p>Event: <span id="eventDesc"></span></p>
  <p>Amount: <span id="amount"></span></p>
  <p>Total: <span id="total"></span></p>
</div>

<!-- Download Button -->
<button id="downloadBtn" style="display:none;">Download Invoice</button>

<!-- ✅ JavaScript -->
<script>
  const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDl2oNe9mONdejXYfXqk3hjdVZUWHsfdN47F54BS4nyufgxV_o2VaCm-upReu1ERhZZQ173TfDJ3B/pub?gid=2055986518&single=true&output=csv";
  let bookings = [];

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch(sheetCSV);
      const csvText = await res.text();

      // Parse CSV → JSON
      const rows = csvText.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      bookings = rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
        return obj;
      });

      populateInstitutions();
    } catch (err) {
      console.error("Error fetching or parsing CSV:", err);
    }
  });

  function populateInstitutions() {
    const instSet = new Set(
      bookings.map(b => b["Name of Institution/Organization/Person"]).filter(Boolean)
    );
    const instSelect = document.getElementById("institutionSelect");

    instSet.forEach(inst => {
      const opt = document.createElement("option");
      opt.value = inst;
      opt.textContent = inst;
      instSelect.appendChild(opt);
    });

    instSelect.onchange = onInstitutionChange;
  }

  function onInstitutionChange() {
    const inst = document.getElementById("institutionSelect").value;
    const eventSelect = document.getElementById("eventSelect");
    const descSelect = document.getElementById("descSelect");

    // Reset dropdowns
    eventSelect.innerHTML = '<option value="">-- Select Event --</option>';
    descSelect.innerHTML = '<option value="">-- Select --</option>';

    if (!inst) { 
      eventSelect.disabled = true; 
      descSelect.disabled = true; 
      return; 
    }

    const filtered = bookings.filter(b => b["Name of Institution/Organization/Person"] === inst);

    filtered.forEach(b => {
      const eOpt = document.createElement("option");
      eOpt.value = b["ID"];
      eOpt.textContent = `${b["Event Description"]} (${b["Event Start Date"]})`; // ✅ fixed
      eventSelect.appendChild(eOpt);

      const dOpt = document.createElement("option");
      dOpt.value = `${b["Venue"]} - ${b["Additional Services"]}`; // ✅ fixed
      dOpt.textContent = `${b["Venue"]} - ${b["Additional Services"]}`;
      descSelect.appendChild(dOpt);
    });

    eventSelect.disabled = false;
    descSelect.disabled = false;
  }

  function generateInvoice() {
    document.getElementById("invNo").textContent = document.getElementById("invoiceId").value;
    document.getElementById("invDate").textContent = document.getElementById("dated").value || new Date().toLocaleDateString();
    document.getElementById("siCell").textContent = document.getElementById("siNo").value;
    document.getElementById("eventDesc").textContent = document.getElementById("descSelect").value;
    document.getElementById("amount").textContent = document.getElementById("amountInput").value;
    document.getElementById("total").textContent = document.getElementById("totalInput").value;

    document.getElementById("invoice").style.display = "block";
    document.getElementById("downloadBtn").style.display = "inline-block";
  }

  document.getElementById("downloadBtn").addEventListener("click", () => {
    const invoiceElem = document.getElementById("invoice");
    html2pdf().from(invoiceElem).save("invoice-" + new Date().getTime() + ".pdf");
  });
</script>

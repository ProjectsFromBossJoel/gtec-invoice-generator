<div class="container">
  <h2>ðŸ“‘ Generate Invoice</h2>

  <!-- Coordinator Form -->
  <div id="formSection">
    <label>Institution:</label>
    <select id="institutionSelect">
      <option value="">-- Select Institution --</option>
    </select><br><br>

    <label>Event / Booking:</label>
    <select id="eventSelect" disabled>
      <option value="">-- Select Event --</option>
    </select><br><br>

    <label>Invoice ID:</label>
    <input type="text" id="invoiceId"><br><br>

    <label>Delivery No.:</label>
    <input type="text" id="deliveryNo"><br><br>

    <label>Dated:</label>
    <input type="date" id="dated"><br><br>

    <label>SI No.:</label>
    <input type="text" id="siNo"><br><br>

    <label>Description (Venue + Services):</label>
    <select id="descSelect">
      <option value="">-- Select --</option>
    </select><br><br>

    <label>Amount:</label>
    <input type="number" id="amountInput"><br><br>

    <label>Total Cost:</label>
    <input type="number" id="totalInput"><br><br>

    <button class="btn" onclick="generateInvoice()">Generate Invoice</button>
  </div>

  <!-- Invoice Output -->
  <div id="invoice" class="invoice-box" style="display:none;">
    <div class="header">
      <div>
        <h3>GTEC HOSPITALITY MANAGEMENT SERVICES</h3>
        <p>P.O. BOX MB 28, MINISTRIES â€“ ACCRA</p>
        <p>Contact: 0244202959, 0244660848</p>
        <p>Email: hospitality@gtec.edu.gh</p>
      </div>
      <div class="right">
        <p><b>Invoice No:</b> <span id="invNo"></span></p>
        <p><b>Date:</b> <span id="invDate"></span></p>
      </div>
    </div>

    <h2 style="text-align:center;">INVOICE</h2>

    <table>
      <tr><th>SI No.</th><th>Description</th><th>Amount</th></tr>
      <tr>
        <td id="siCell">-</td>
        <td id="eventDesc">-</td>
        <td id="amount">-</td>
      </tr>
      <tr>
        <td colspan="2" style="text-align:right;"><b>Total</b></td>
        <td id="total">-</td>
      </tr>
    </table>

    <h3>Bank Details</h3>
    <p><b>A/c Holderâ€™s Name:</b> GTEC CONFERENCE</p>
    <p><b>Bank Name:</b> AGRICULTURAL DEVELOPMENT BANK</p>
    <p><b>A/c No.:</b> 0701010009158801</p>
    <p><b>Branch & Bank Code:</b> Gulf House</p>

    <p style="margin-top:30px;"><i>Kindly Note: 50% payment required to secure venue.</i></p>
  </div>

  <button id="downloadBtn" class="btn" style="display:none;">Download PDF</button>
</div>

<script>
  const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDl2oNe9mONdejXYfXqk3hjdVZUWHsfdN47F54BS4nyufgxV_o2VaCm-upReu1ERhZZQ173TfDJ3B/pub?gid=2055986518&single=true&output=csv";
  let bookings = [];

  document.addEventListener("DOMContentLoaded", async () => {
    const res = await fetch(sheetCSV);
    const csvText = await res.text();

    // Parse CSV â†’ JSON
    const rows = csvText.trim().split("\n").map(r => r.split(","));
    const headers = rows[0];
    bookings = rows.slice(1).map(r => {
      let obj = {};
      headers.forEach((h, i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
      return obj;
    });

    populateInstitutions();
  });

  function populateInstitutions() {
    const instSet = new Set(bookings.map(b => b["Name of Institution/Organization/Person"]).filter(Boolean));
    const instSelect = document.getElementById("institutionSelect");
    instSet.forEach(inst => {
      const opt = document.createElement("option");
      opt.value = inst;
      opt.textContent = inst;
      instSelect.appendChild(opt);
    });
    instSelect.onchange = onInstitutionChange;
  }

  function onInstitutionChange() {
    const inst = document.getElementById("institutionSelect").value;
    const eventSelect = document.getElementById("eventSelect");
    const descSelect = document.getElementById("descSelect");
    eventSelect.innerHTML = '<option value="">-- Select Event --</option>';
    descSelect.innerHTML = '<option value="">-- Select --</option>';

    if (!inst) { eventSelect.disabled = true; return; }

    const filtered = bookings.filter(b => b["Name of Institution/Organization/Person"] === inst);

    filtered.forEach(b => {
      const eOpt = document.createElement("option");
      eOpt.value = b["ID"];
      eOpt.textContent = `${b["Event Description"]} (${b["Event Start Date"]})`;
      eventSelect.appendChild(eOpt);

      const dOpt = document.createElement("option");
      dOpt.value = `${b["Venue"]} - ${b["Additional Services"]}`;
      dOpt.textContent = `${b["Venue"]} - ${b["Additional Services"]}`;
      descSelect.appendChild(dOpt);
    });

    eventSelect.disabled = false;
  }

  function generateInvoice() {
    document.getElementById("invNo").textContent = document.getElementById("invoiceId").value;
    document.getElementById("invDate").textContent = document.getElementById("dated").value || new Date().toLocaleDateString();
    document.getElementById("siCell").textContent = document.getElementById("siNo").value;
    document.getElementById("eventDesc").textContent = document.getElementById("descSelect").value;
    document.getElementById("amount").textContent = document.getElementById("amountInput").value;
    document.getElementById("total").textContent = document.getElementById("totalInput").value;

    document.getElementById("invoice").style.display = "block";
    document.getElementById("downloadBtn").style.display = "inline-block";
  }

  document.getElementById("downloadBtn").addEventListener("click", () => {
    const invoiceElem = document.getElementById("invoice");
    html2pdf().from(invoiceElem).save("invoice-" + new Date().getTime() + ".pdf");
  });
</script>

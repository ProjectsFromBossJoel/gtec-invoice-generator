<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; }
    .container { display: flex; height: 100vh; }
    .form-section, .preview-section { flex: 1; padding: 20px; overflow-y: auto; }
    .form-section { background: #fff; border-right: 2px solid #ddd; }
    h2 { text-align: center; margin-bottom: 15px; color: #333; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
    button { margin-top: 15px; padding: 10px 20px; border: none; border-radius: 6px; background: #007bff; color: #fff; font-weight: bold; cursor: pointer; }
    button:hover { background: #0056b3; }
    .invoice { background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 8px; display: none; }
    .invoice-header { text-align: center; margin-bottom: 20px; }
    #downloadBtn { display: none; margin-top: 10px; background: #28a745; }
    #downloadBtn:hover { background: #1e7e34; }
  </style>
</head>
<body>

<div class="container">
  <!-- LEFT FORM -->
  <div class="form-section">
    <h2>Invoice Form</h2>
    <label for="institutionSelect">Institution</label>
    <select id="institutionSelect"><option value="">-- Select Institution --</option></select>

    <label for="applicantSelect">Applicant Name</label>
    <select id="applicantSelect" disabled><option value="">-- Select Applicant --</option></select>

    <label for="eventSelect">Event</label>
    <select id="eventSelect" disabled><option value="">-- Select Event --</option></select>

    <label for="descSelect">Venue & Services</label>
    <select id="descSelect" disabled><option value="">-- Select --</option></select>

    <label for="serviceSelect">Additional Services</label>
    <select id="serviceSelect" disabled><option value="">-- Select --</option></select>

    <label for="invoiceId">Invoice No.</label>
    <input type="text" id="invoiceId" placeholder="Enter Invoice No.">

    <label for="dated">Date</label>
    <input type="date" id="dated">

    <label for="siNo">SI No.</label>
    <input type="text" id="siNo" placeholder="Enter SI No.">

    <label for="amountInput">Amount</label>
    <input type="number" id="amountInput" placeholder="Enter Amount">

    <label for="totalInput">Total</label>
    <input type="number" id="totalInput" placeholder="Enter Total">

    <button onclick="generateInvoice()">Generate Invoice</button>
  </div>

  <!-- RIGHT PREVIEW -->
  <div class="preview-section">
    <div id="invoice" class="invoice">
      <div class="invoice-content">
        <!-- HEADER -->
        <table style="width:100%; border-collapse: collapse;">
          <tr>
            <td style="width:70%; vertical-align: top;">
              <p><b>GTEC HOSPITALITY MANAGEMENT SERVICES</b></p>
              <p>P.O.BOX MB 28</p>
              <p>MINISTRIES â€“ ACCRA</p>
              <p>Contact: 0244202959, 0244660848</p>
              <p>Email: hospitality@gtec.edu.gh</p>
              <p><b>Applicant:</b> <span id="applicantName"></span></p>
            </td>
            <td style="width:30%; border:1px solid #000; padding:5px;">
              <p><b>Invoice No.:</b> <span id="invNo"></span></p>
              <p><b>Dated:</b> <span id="invDate"></span></p>
            </td>
          </tr>
        </table>

        <h2 style="text-align:center; margin:10px 0;">INVOICE</h2>

        <!-- TABLE -->
        <table style="width:100%; border-collapse: collapse;" border="1">
          <tr>
            <th style="width:10%;">SI No.</th>
            <th style="width:70%;">DESCRIPTION</th>
            <th style="width:20%;">AMOUNT</th>
          </tr>
          <tr>
            <td id="siCell"></td>
            <td>
              <div><span id="eventDesc"></span></div>
              <div><b>Additional Services:</b> <span id="serviceDesc"></span></div>
            </td>
            <td id="amount"></td>
          </tr>
          <tr>
            <td colspan="2" style="text-align:right;"><b>TOTAL</b></td>
            <td id="total"></td>
          </tr>
        </table>
      </div>
    </div>
    <button id="downloadBtn">Download PDF</button>
  </div>
</div>

<script>
  const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDl2oNe9mONdejXYfXqk3hjdVZUWHsfdN47F54BS4nyufgxV_o2VaCm-upReu1ERhZZQ173TfDJ3B/pub?gid=2055986518&single=true&output=csv";
  let bookings = [];

  document.addEventListener("DOMContentLoaded", async () => {
    const res = await fetch(sheetCSV);
    const csvText = await res.text();
    const rows = csvText.trim().split("\n").map(r => r.split(","));
    const headers = rows[0];
    bookings = rows.slice(1).map(r => {
      let obj = {};
      headers.forEach((h, i) => obj[h.trim()] = r[i] ? r[i].trim() : "");
      return obj;
    });
    populateInstitutions();
  });

  function populateInstitutions() {
    const instSet = new Set(bookings.map(b => b["Name of Institution/Organization/Person"]).filter(Boolean));
    const instSelect = document.getElementById("institutionSelect");
    instSet.forEach(inst => {
      const opt = document.createElement("option");
      opt.value = inst;
      opt.textContent = inst;
      instSelect.appendChild(opt);
    });
    instSelect.onchange = onInstitutionChange;
  }

  function onInstitutionChange() {
    const inst = document.getElementById("institutionSelect").value;
    const applicantSelect = document.getElementById("applicantSelect");
    const eventSelect = document.getElementById("eventSelect");
    const descSelect = document.getElementById("descSelect");
    const serviceSelect = document.getElementById("serviceSelect");

    applicantSelect.innerHTML = '<option value="">-- Select Applicant --</option>';
    eventSelect.innerHTML = '<option value="">-- Select Event --</option>';
    descSelect.innerHTML = '<option value="">-- Select --</option>';
    serviceSelect.innerHTML = '<option value="">-- Select --</option>';

    if (!inst) { applicantSelect.disabled = eventSelect.disabled = descSelect.disabled = serviceSelect.disabled = true; return; }

    const filtered = bookings.filter(b => b["Name of Institution/Organization/Person"] === inst);

    filtered.forEach(b => {
      const aOpt = document.createElement("option");
      aOpt.value = b["Applicant Name"];
      aOpt.textContent = b["Applicant Name"];
      applicantSelect.appendChild(aOpt);

      const eOpt = document.createElement("option");
      eOpt.value = b["ID"];
      eOpt.textContent = `${b["Event Description"]} (${b["Event Start Date"]})`;
      eventSelect.appendChild(eOpt);

      const dOpt = document.createElement("option");
      dOpt.value = b["Venue"];
      dOpt.textContent = b["Venue"];
      descSelect.appendChild(dOpt);

      const sOpt = document.createElement("option");
      sOpt.value = b["Additional Services"];
      sOpt.textContent = b["Additional Services"];
      serviceSelect.appendChild(sOpt);
    });

    applicantSelect.disabled = eventSelect.disabled = descSelect.disabled = serviceSelect.disabled = false;
  }

  function generateInvoice() {
    document.getElementById("invNo").textContent = document.getElementById("invoiceId").value;
    document.getElementById("invDate").textContent = document.getElementById("dated").value || new Date().toLocaleDateString();
    document.getElementById("siCell").textContent = document.getElementById("siNo").value;
    document.getElementById("applicantName").textContent = document.getElementById("applicantSelect").value;
    document.getElementById("eventDesc").textContent = document.getElementById("descSelect").value;
    document.getElementById("serviceDesc").textContent = document.getElementById("serviceSelect").value;
    document.getElementById("amount").textContent = document.getElementById("amountInput").value;
    document.getElementById("total").textContent = document.getElementById("totalInput").value;

    document.getElementById("invoice").style.display = "block";
    document.getElementById("downloadBtn").style.display = "inline-block";
  }

  document.getElementById("downloadBtn").addEventListener("click", () => {
    const invoiceElem = document.getElementById("invoice");
    html2pdf().from(invoiceElem).save("invoice-" + new Date().getTime() + ".pdf");
  });
</script>
</body>
</html>
